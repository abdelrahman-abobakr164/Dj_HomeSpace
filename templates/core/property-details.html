{% extends 'base.html' %}
{% load static %} 
{% load humanize %}
{% block title %} PropertyDetail {% endblock title %}

{% block body %}

  <main class="main">
    <!-- Page Title -->
    <div class="page-title light-background">
      <div class="container d-lg-flex justify-content-between align-items-center">
        <h1 class="mb-2 mb-lg-0">Property Details</h1>
        <nav class="breadcrumbs">
          <ol>
            <li><button onclick="history.back()" class='btn'><a>Home</a></button></li>
            <li class="current">Property Details</li>
          </ol>
        </nav>
      </div>
    </div><!-- End Page Title -->

    <!-- Property Details Section -->
    <section id="property-details" class="property-details section">

      <div class="container" data-aos="fade-up" data-aos-delay="100">

        <div class="row">
          <div class="col-lg-7">

            <!-- Property Hero Section -->
            <div class="property-hero mb-5" data-aos="fade-up" data-aos-delay="200">
              <div class="hero-image-container">
                <div class="property-gallery-slider swiper init-swiper">
                  <script type="application/json" class="swiper-config">
                    {
                      "loop": true,
                      "speed": 600,
                      "autoplay": {
                        "delay": 5000
                      },
                      "navigation": {
                        "nextEl": ".swiper-button-next",
                        "prevEl": ".swiper-button-prev"
                      },
                      "thumbs": {
                        "swiper": ".property-thumbnails-slider"
                      }
                    }
                  </script>
                  <div class="swiper-wrapper">
                    <div class="swiper-slide">
                      {% if p.main_image.url|slice:"-3:" == "mp4" %}
                      <div class="video-container"> 
                        <video class="img-fluid hero-image" alt="Property Main File" controls>
                          <source src="{{ p.main_image.url }}" type="video/mp4" />
                        </video>
                      </div>
                    {% else %}
                      <img src="{{ p.main_image.url }}" class="img-fluid hero-image" alt="Property Main Image">
                    {% endif %}

                      <div class="hero-overlay">
                        <div class="property-badge">
                        {% if p.property_type == "For Rent" %}
                        <span class="status-badge" style='background: linear-gradient(135deg, #8b5cf6, #a78bfa'>For Rent</span>
                        {% elif p.property_type == "For Sale" %}
                        <span class="status-badge for-sale">For Sale</span>
                          {% if p.discount_price %}
                            <span class="featured-badge" style='background: linear-gradient(135deg, #ef4444, #f87171);'>Price Reduced</span>
                          {% endif %}
                        {% endif %}
                        </div>
                      </div>
                    </div>

                    {% if p.gallaries.all %}
                      {% for i in p.gallaries.all %}
                        <div class="swiper-slide">
                          <img src="{{ i.images.url }}" class="img-fluid hero-image" alt="Interior View">
                        </div>
                      {% endfor %}
                    {% endif %}

                  </div>
                  <div class="swiper-button-next"></div>
                  <div class="swiper-button-prev"></div>
                </div>
              </div>

              <div class="thumbnail-gallery mt-3">
                <div class="property-thumbnails-slider swiper init-swiper">
                  <script type="application/json" class="swiper-config">
                    {
                      "loop": true,
                      "spaceBetween": 10,
                      "slidesPerView": 4,
                      "freeMode": true,
                      "watchSlidesProgress": true,
                      "breakpoints": {
                        "576": {
                          "slidesPerView": 5
                        },
                        "768": {
                          "slidesPerView": 6
                        }
                      }
                    }
                  </script>
                    <div class="swiper-wrapper">
                      <div class="swiper-slide">
                        {% if p.main_image.url|slice:"-3:" == "mp4" %}
                          <div class="video-container"> 
                            <video class="img-fluid thumbnail-img" alt="Property Main File" controls>
                              <source src="{{ p.main_image.url }}" type="video/mp4" />
                            </video>
                          </div>
                        {% else %}
                          <img src="{{ p.main_image.url }}" class="img-fluid thumbnail-img" alt="Property Main Image">
                        {% endif %}
                      </div>
                      {% if p.gallaries.all %}
                        {% for i in p.gallaries.all %}
                          <div class="swiper-slide">
                            <img src="{{ i.images.url }}" class="img-fluid thumbnail-img" alt="Property Main Image">
                          </div>
                        {% endfor %}
                      {% endif %} 
                    </div>
                </div>
              </div>
            </div><!-- End Property Hero -->

            <!-- Property Information -->
            <div class="property-info mb-5" data-aos="fade-up" data-aos-delay="300">
              <div class="property-header">
                <h1 class="property-title">{{ p.name }}</h1>
                <div class="property-meta">
                  <span class="address"><i class="bi bi-geo-alt"></i>{{ p.address }}</span>
                </div>
              </div>
              {% if p.property_type == "For Rent" %}
                <div class="pricing-section">
                  <div class="main-price">${{ p.rent|intcomma }}<span class="period">/month</span></div> 
                  <div class="price-breakdown">
                    <span class="deposit d-flex">Security Deposit: ${{ p.security_deposit }}</span>
                    {% if p.available %}
                      <span class="available">Available</span>
                    {% else %}
                      <span class="available">Available At {{ p.available_at|date:'M d' }}</span>
                    {% endif %}
                  </div>
                </div>
              {% else %}
                <div class="pricing-section">
                  {% if p.discount_price %}
                    <div class="main-price mb-2">${{ p.discount_price|intcomma }}</div>
                    <del><div class="main-price" style='font-size: 30px;'>${{ p.price|intcomma }}</div></del>
                  {% else %}
                    <div class="main-price">${{ p.price|intcomma }}</div>
                  {% endif %}
                  {% if p.available %}
                    <span class="available">Available</span>
                  {% else %}
                    <span class="available">Available at: {{ p.available_at|date:'M, d' }}</span>
                  {% endif %}
                </div>
              {% endif %}

              <div class="quick-stats">
                <div class="stat-grid">
                  <div class="stat-card">
                    <div class="stat-icon">
                      <i class="bi bi-house"></i>
                    </div>
                    <div class="stat-content">
                      <span class="stat-number">{{ p.bedrooms }}</span>
                      <span class="stat-label">Bedrooms</span>
                    </div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-icon">
                      <i class="bi bi-droplet"></i>
                    </div>
                    <div class="stat-content">
                      <span class="stat-number">{{ p.bathrooms }}</span>
                      <span class="stat-label">Bathrooms</span>
                    </div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-icon">
                      <i class="bi bi-arrows-angle-expand"></i>
                    </div>
                    <div class="stat-content">
                      <span class="stat-number">{{ p.meter|intcomma }}</span>
                      <span class="stat-label">Sq Ft</span>
                    </div>
                  </div>

                </div>
              </div>
            </div><!-- End Property Information -->

            <!-- Description & Features -->
            <div class="property-details mb-5" data-aos="fade-up" data-aos-delay="400">
              <h3>Property Description</h3>
              <p>{{ p.description }}</p>
              
              {% if p.interior_features.all or p.building_amenities.all %}
                <div class="features-grid mt-4">
                  <div class="row">
                    {% if p.interior_features.all %}
                      <div class="col-md-6">
                        <h5>Interior Features</h5>
                        <ul class="feature-list">
                          {% for i in p.interior_features.all %}
                            <li><i class="bi bi-check2"></i>{{ i.name }}</li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                    {% if p.building_amenities.all %}
                      <div class="col-md-6">
                        <h5>Building Amenities</h5>
                        <ul class="feature-list">
                          {% for i in p.building_amenities.all %}
                            <li><i class="bi bi-check2"></i> {{ i.name }}</li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endif %}

            </div><!-- End Description & Features -->

          </div>

          <!-- Sidebar -->
          <div class="col-lg-5">
            <div class="sticky-sidebar">

              <!-- Agent Card -->
              <div class="agent-card mb-4" data-aos="fade-up" data-aos-delay="350">
                <div class="agent-header">
                  <div class="agent-avatar">
                    
                    {% if p.agent.image %}
                      <img src="{{ p.agent.image.url }}" class="img-fluid" alt="Agent Photo">
                    {% else %}
                      <img src="{% static 'assets/img/1.png' %}" class="img-fluid" alt="Agent Photo">
                    {% endif %}
                      
                  </div>
                  <div class="agent-info mt-4">
                    <h4>{{ p.agent.username }}</h4>
                  </div>
                </div>

                <div class="agent-contact">
                  <div class="contact-item">
                    <i class="bi bi-phone"></i>
                    <span>{{ p.agent.phone }}</span>
                  </div>
                  <div class="contact-item">
                    <i class="bi bi-envelope"></i>
                    <span>{{ p.agent.email }}</span>
                  </div>
                </div>
                {% if p.agent == request.user %}
                  <div class="d-flex">
                    <a href="{% url 'property_update' p.id %}" class='btn btn-dark'>Change</a>
                    <button type="button" class='btn btn-danger' data-bs-toggle='modal' 
                    data-bs-target="#deleteModal" 
                    data-bs-url='{% url "property_delete" p.id %}'style='margin-left: auto'>Delete</button>
                  </div>
                {% endif %}
              </div><!-- End Agent Card -->

              <!-- Contact Form -->
              <div class="contact-form-card mb-4" data-aos="fade-up" data-aos-delay="450">
                <h4>Schedule Viewing</h4>
                <form action="{% url 'contact-agent' p.id %}" method="POST" id="contactagentForm" >
                  {% csrf_token %}

                  <div class="row">
                    <div class="col-12 mb-3">
                      
                      {% if request.user.is_authenticated %}
                        {{form.as_p}}
                      {% endif %}

                    </div>
                  </div>

                  <div class="actions-card mb-4" data-aos="fade-up" data-aos-delay="250">
                    <div class="action-buttons">
                      <p class="text-danger text-center" id="id_p"></p>
                      {% if request.user.is_authenticated %}
                        <button type='submit' class="btn btn-primary btn-lg w-100 mb-3">
                          <i class="bi bi-calendar-check"></i>Send Request</button>
                      {% else %}
                        <a href="{% url 'account_login' %}" class="btn btn-primary btn-lg w-100 mb-3">Login</a>
                      {% endif %}
                    </div>
                  </div>
                </form>
              </div><!-- End Contact Form -->
              
              {% if similar_properties %}
                <div class="similar-properties" data-aos="fade-up" data-aos-delay="650">
                  <h4>Similar Properties</h4>
                  {% for i in similar_properties %}
                    <div class="similar-property-item">
                      <a href="{% url 'property' i.id %}"><img src="{% static 'assets/img/real-estate/property-exterior-4.webp' %}" class="img-fluid" alt="Similar Property">
                      <div class="similar-info">
                        <h6>{{ i.name }}</h6>
                        {% if i.property_type == "For Rent" %}
                          <p class="similar-price">${{ i.rent|intcomma }}/month</p>

                        {% elif i.discount_price %}
                          <p class="similar-price">${{ i.discount_price|intcomma }}</p>
                        {% else %}
                          <p class="similar-price">${{ i.price|intcomma }}</p>
                        {% endif %}
                        <p class="similar-specs">{{i.bedrooms}} bed • {{i.bathrooms}} bath • {{i.meter|intcomma}} sq ft</p></a>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}

            </div>
          </div><!-- End Sidebar -->

        </div>
      </div>

    </section><!-- /Property Details Section -->

  </main>

  
  {% if p.agent == request.user %}
    <!-- Delete Property Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Delete Property</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this property? This action cannot be undone.</p>
            <p class="text-muted"><strong>Property:</strong> {{ p.name }}</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <form id="deleteForm" method="POST" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Yes</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <script>
    // Update form action when modal is shown
    document.getElementById('deleteModal').addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget;
      var url = button.getAttribute('data-bs-url');
      var form = document.getElementById('deleteForm');
      form.action = url;
    });
  </script>

{% endblock body %}